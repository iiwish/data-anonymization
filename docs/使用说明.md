# 数据匿名化与解密服务 - 使用说明

## 概述

本服务提供数据匿名化和解密功能，专为需要与第三方AI系统交互的场景设计。服务包含两个核心接口：匿名化接口和解密接口，支持多租户鉴权和详细日志记录。

## 快速开始

### 1. 环境准备

- Go 1.24.3 或更高版本
- 配置文件 `config.json`

### 2. 配置文件

复制示例配置文件并修改：

```powershell
Copy-Item config.example.json config.json
```

配置文件示例：

```json
{
  "server": {
    "port": 8080,
    "host": "0.0.0.0"
  },
  "systems": [
    {
      "system_id": "BI_REPORT_SYSTEM",
      "shared_secret": "a_very_strong_and_long_secret_for_bi",
      "description": "商业智能报表分析系统"
    },
    {
      "system_id": "CUSTOMER_SERVICE_BOT",
      "shared_secret": "another_unique_secret_for_the_chatbot",
      "description": "客户服务聊天机器人"
    }
  ],
  "logging": {
    "level": "INFO",
    "file_path": "logs/service.log"
  }
}
```

### 3. 启动服务

```powershell
# 编译
go build -o data-anonymization.exe ./cmd/server

# 运行
.\data-anonymization.exe -config config.json
```

服务将在配置端口启动（默认8080）。

## 鉴权机制

所有API请求都需要HMAC-SHA256签名鉴权。

### 签名生成步骤

1. **准备参数**：
   - `SystemID`: 系统ID（如 "BI_REPORT_SYSTEM"）
   - `UserID`: 用户ID（如 "user123"）
   - `Timestamp`: Unix时间戳（如 1698765432）
   - `RequestBody`: 请求体的JSON字符串

2. **计算签名内容**：
   ```
   signContent = SystemID + UserID + Timestamp + SHA256(RequestBody)
   ```

3. **生成签名**：
   ```
   Signature = HMAC-SHA256(shared_secret, signContent)
   ```

4. **设置请求头**：
   ```
   Authorization: MCP-HMAC-SHA256 SystemID=BI_REPORT_SYSTEM,UserID=user123,Timestamp=1698765432,Signature=...
   ```

### Go代码示例

```go
import (
    "crypto/hmac"
    "crypto/sha256"
    "encoding/hex"
    "strconv"
    "time"
)

func generateSignature(systemID, userID, secret, requestBody string) string {
    // 计算请求体的SHA256
    bodyHash := sha256.Sum256([]byte(requestBody))
    bodyHashStr := hex.EncodeToString(bodyHash[:])

    // 生成时间戳
    timestamp := strconv.FormatInt(time.Now().Unix(), 10)

    // 构建签名内容
    signContent := systemID + userID + timestamp + bodyHashStr

    // 计算HMAC-SHA256
    h := hmac.New(sha256.New, []byte(secret))
    h.Write([]byte(signContent))
    signature := hex.EncodeToString(h.Sum(nil))

    return signature
}
```

## API接口说明

### 1. 匿名化接口

**接口地址**: `POST /v1/anonymize`

**功能**: 将敏感数据替换为安全编码，并生成映射表供后续解密使用。

**请求示例**:

```bash
POST /v1/anonymize
Authorization: MCP-HMAC-SHA256 SystemID=BI_REPORT_SYSTEM,UserID=user123,Timestamp=1698765432,Signature=...
Content-Type: application/json

{
  "session_id": "sess_a8f5b_random_string_here",
  "payload": {
    "metadata": {
      "report_name": "Q3 Sales Analysis for {华东}",
      "requester": "user123"
    },
    "analysis_prompt": "Analyze the following sales data. The previous quarter's top product was '手机'. Focus on the performance of '华东' and compare it with other regions. The total revenue for Q2 was 1500000.",
    "data_table": [
      {
        "区域": "华东",
        "核心产品": "手机",
        "季度收入": 1500000,
        "同比增长率": "12.5%",
        "活跃用户数": 12000
      },
      {
        "区域": "华北",
        "核心产品": "电脑",
        "季度收入": 950000,
        "同比增长率": "-3.2%",
        "活跃用户数": 8500
      }
    ]
  },
  "anonymization_rules": [
    {
      "strategy": "MAP_CODE",
      "applies_to": { "type": "REGION", "values": ["华东", "华北"] }
    },
    {
      "strategy": "MAP_CODE",
      "applies_to": { "type": "PRODUCT", "values": ["手机", "电脑"] }
    },
    {
      "strategy": "TRANSFORM",
      "strategy_params": { "noise_level": 0.05 },
      "applies_to": { "type": "REVENUE", "values": [1500000, 950000] }
    },
    {
      "strategy": "MAP_PLACEHOLDER",
      "applies_to": { "type": "USER_COUNT", "values": [12000, 8500] }
    },
    {
      "strategy": "PASSTHROUGH",
      "applies_to": { "type": "GROWTH_RATE", "values": ["12.5%", "-3.2%"] }
    }
  ]
}
```

**响应示例**:

```json
{
  "session_id": "sess_a8f5b_random_string_here",
  "anonymized_payload": {
    "metadata": {
      "report_name": "Q3 Sales Analysis for {REGION_a3f5}",
      "requester": "user123"
    },
    "analysis_prompt": "Analyze the following sales data. The previous quarter's top product was 'PRODUCT_c8b1'. Focus on the performance of 'REGION_a3f5' and compare it with other regions. The total revenue for Q2 was 1532108.5.",
    "data_table": [
      {
        "区域": "REGION_a3f5",
        "核心产品": "PRODUCT_c8b1",
        "季度收入": 1532108.5,
        "同比增长率": "12.5%",
        "活跃用户数": "USER_COUNT_plc_1"
      },
      {
        "区域": "REGION_b1e9",
        "核心产品": "PRODUCT_d2a7",
        "季度收入": 988450.0,
        "同比增长率": "-3.2%",
        "活跃用户数": "USER_COUNT_plc_2"
      }
    ]
  },
  "mappings_to_store": {
    "categorical_mappings": {
      "REGION": { "REGION_a3f5": "华东", "REGION_b1e9": "华北" },
      "PRODUCT": { "PRODUCT_c8b1": "手机", "PRODUCT_d2a7": "电脑" }
    },
    "metric_placeholder_mappings": {
      "USER_COUNT_plc_1": 12000,
      "USER_COUNT_plc_2": 8500
    }
  }
}
```

**说明**:
- `mappings_to_store` 包含了所有映射关系，客户端需要将其持久化存储，用于后续解密。
- 匿名化策略包括：MAP_CODE（映射编码）、TRANSFORM（数值加噪）、MAP_PLACEHOLDER（占位符映射）、PASSTHROUGH（透传）。

### 2. 解密接口

**接口地址**: `POST /v1/decrypt`

**功能**: 将包含匿名编码的数据还原为原始数据。

**请求示例1 (推荐：解密JSON对象)**:

```bash
POST /v1/decrypt
Authorization: MCP-HMAC-SHA256 SystemID=BI_REPORT_SYSTEM,UserID=user123,Timestamp=1698765432,Signature=...
Content-Type: application/json

{
  "data_with_anonymized_codes": {
    "summary": "REGION_a3f5 区域表现突出，主要贡献来自 PRODUCT_c8b1。",
    "key_findings": [
      { "dimension": "区域", "value": "REGION_a3f5" },
      { "dimension": "产品", "value": "PRODUCT_c8b1" }
    ]
  },
  "mappings": {
    "categorical_mappings": {
      "REGION": { "REGION_a3f5": "华东", "REGION_b1e9": "华北" },
      "PRODUCT": { "PRODUCT_c8b1": "手机", "PRODUCT_d2a7": "电脑" }
    },
    "metric_placeholder_mappings": {
      "USER_COUNT_plc_1": 12000,
      "USER_COUNT_plc_2": 8500
    }
  }
}
```

**响应示例1**:

```json
{
  "decrypted_data": {
    "summary": "华东 区域表现突出，主要贡献来自 手机。",
    "key_findings": [
      { "dimension": "区域", "value": "华东" },
      { "dimension": "产品", "value": "手机" }
    ]
  }
}
```

**请求示例2 (解密纯文本字符串)**:

```bash
POST /v1/decrypt
Authorization: MCP-HMAC-SHA256 SystemID=BI_REPORT_SYSTEM,UserID=user123,Timestamp=1698765432,Signature=...
Content-Type: application/json

{
  "data_with_anonymized_codes": "分析显示，REGION_a3f5 区域的 PRODUCT_c8b1 表现最佳，活跃用户数为 USER_COUNT_plc_1。",
  "mappings": {
    "categorical_mappings": {
      "REGION": { "REGION_a3f5": "华东", "REGION_b1e9": "华北" },
      "PRODUCT": { "PRODUCT_c8b1": "手机", "PRODUCT_d2a7": "电脑" }
    },
    "metric_placeholder_mappings": {
      "USER_COUNT_plc_1": 12000,
      "USER_COUNT_plc_2": 8500
    }
  }
}
```

**响应示例2**:

```json
{
  "decrypted_data": "分析显示，华东 区域的 手机 表现最佳，活跃用户数为 12000。"
}
```

**说明**:
- 推荐使用JSON对象格式，因为它提供更好的上下文和安全性。
- 纯文本字符串解密可能存在歧义风险，不推荐用于生产环境。

## 错误处理

服务返回标准HTTP状态码：

- `200`: 成功
- `400`: 请求参数错误
- `401`: 鉴权失败
- `500`: 服务器内部错误

错误响应格式：

```json
{
  "error": "错误描述",
  "code": "ERROR_CODE"
}
```

## 日志记录

所有请求都会记录到配置文件指定的日志文件中，格式为JSON：

```json
{
  "timestamp": "2025-10-23T08:30:00.123Z",
  "request_id": "uuid-v4",
  "service": "AnonymizationService",
  "system_id": "BI_REPORT_SYSTEM",
  "user_id": "user123",
  "status": "SUCCESS",
  "latency_ms": 15,
  "error_message": null
}
```

## 最佳实践

1. **使用JSON格式**: 在AI交互中，强制要求AI返回结构化JSON，以确保解密的安全性和准确性。
2. **映射表管理**: 妥善存储和管理映射表，确保解密时能够正确还原数据。
3. **密钥安全**: 使用强密钥，定期轮换，避免在代码中硬编码密钥。
4. **时间戳验证**: 客户端和服务端时间应保持同步，时间戳窗口默认为5分钟。
5. **HTTPS**: 生产环境必须使用HTTPS传输。

## 故障排除

- **鉴权失败**: 检查签名算法、时间戳和密钥配置。
- **解密失败**: 确认映射表完整性和编码格式。
- **性能问题**: 考虑使用缓存存储频繁访问的映射表。

如有问题，请查看日志文件或提交Issue。