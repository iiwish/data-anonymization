好的，作为一名顶级的架构师，我将为您整合并优化这两份文档，创建一个单一、清晰、完整的最终设计文档。

新文档将无缝融入“AI返回JSON结构”的设计理念，并根据您的要求重新设计密钥管理和增加日志记录功能。解密服务将明确支持文本和JSON两种载体，同时强调JSON作为最佳实践的战略价值。

---

### **通用数据隐私保护服务 - 统一设计文档**

**文档版本:** 3.0
**核心焦点:** 为AI交互设计的、具备多租户密钥管理和详细日志记录的匿名化与解密服务。
**最后更新:** 2025年10月23日

#### **1. 服务概述**

本设计文档定义了两个独立、无状态的HTTP微服务：**匿名化服务**和**解密服务**。这两个服务共同构成了一套通用的数据隐私保护解决方案，旨在安全地处理需要与第三方系统（如大型语言模型AI）交互的结构化和非结构化数据。

*   **匿名化服务 (Anonymization Service):** 接收一份包含潜在敏感信息的JSON载荷，并根据一组明确的规则，将其转换为一份结构相同但敏感信息已被替换为安全编码的匿名化载荷。
*   **解密服务 (Decryption Service):** 接收一份包含安全编码的载荷（通常由AI返回，可以是**JSON对象**或**纯文本字符串**），并利用匿名化过程中产生的映射关系，将其还原为一份包含原始真实数据的可读载荷。

这两个服务被设计为纯粹的功能转换器，不包含任何业务逻辑，确保了其高度的可复用性、健壮性和通用性。

---

#### **2. 密钥管理、鉴权与日志**

##### **2.1 密钥管理**

为了支持多个不同的业务系统（租户）安全地接入本服务，密钥管理采用基于配置文件的方式，为每个系统分配独立的密钥。

*   **配置文件 (`config.json`):** 服务在启动时加载此文件，其中包含了所有接入系统的认证信息。

    ```json
    {
      "systems": [
        {
          "system_id": "BI_REPORT_SYSTEM",
          "shared_secret": "a_very_strong_and_long_secret_for_bi",
          "description": "商业智能报表分析系统"
        },
        {
          "system_id": "CUSTOMER_SERVICE_BOT",
          "shared_secret": "another_unique_secret_for_the_chatbot",
          "description": "客户服务聊天机器人"
        }
      ]
    }
    ```

##### **2.2 鉴权机制**

所有API调用都必须经过鉴权。采用基于HMAC的Token机制，并与多租户密钥管理相结合。

*   **Token生成 (由客户端完成):**
    1.  客户端必须明确自己的`system_id`。
    2.  **签名内容:** 拼接字符串 `SystemID + UserID + UnixTimestamp + SHA256(RequestBody)`。
    3.  **签名:** `Signature = HMAC-SHA256(SHARED_SECRET_FOR_SYSTEM, 签名内容)`。
    4.  **HTTP头:**
        ```
        Authorization: MCP-HMAC-SHA256 SystemID={...},UserID={...},Timestamp={...},Signature={...}
        ```

*   **Token验证 (在服务入口中间件完成):**
    1.  从`Authorization`头中解析出`SystemID`。
    2.  根据`SystemID`从配置中查找对应的`shared_secret`。如果未找到，拒绝请求。
    3.  校验时间戳是否在有效窗口内（建议5分钟）。
    4.  在服务端使用查找到的密钥重新计算签名，并与客户端传入的`Signature`进行比对。

##### **2.3 日志记录**

所有请求（无论成功或失败）都必须被记录，以便进行审计、监控和问题排查。日志应采用结构化的JSON格式。

*   **日志内容:**
    ```json
    {
      "timestamp": "2025-10-23T08:30:00.123Z",
      "request_id": "uuid-v4-of-the-request",
      "service": "DecryptionService", // 或 AnonymizationService
      "system_id": "BI_REPORT_SYSTEM",
      "user_id": "user123",
      "status": "SUCCESS", // 或 FAILED
      "latency_ms": 15,
      "error_message": null // 或具体的错误信息
    }
    ```

---

#### **3. 匿名化服务 (Anonymization Service)**

##### **3.1 功能与逻辑**

该服务接收一个JSON载荷和一组规则。它会递归地遍历整个载荷，查找所有在规则中被声明为敏感的值，并根据指定的策略进行替换，同时生成一份供解密服务使用的映射表。

*   **核心能力:**
    *   **载荷不可知:** 能处理任意复杂的JSON结构。
    *   **全局替换:** 一个敏感值无论出现多少次，都会被一致地替换为同一个编码。
    *   **策略驱动:** 支持多种隐私保护策略（映射编码、加噪、占位符等）。
    *   **映射生成:** 生成一份详细的“编码 -> 真实值”的映射表。

##### **3.2 API接口**


*   **Endpoint:** `POST /v1/anonymize`
*   **Request Body (清晰示例):**

    ```json
    {
      "session_id": "sess__a8f5b_random_string_here",
      "payload": {
        "metadata": {
          "report_name": "Q3 Sales Analysis for {华东}",
          "requester": "user123"
        },
        "analysis_prompt": "Analyze the following sales data. The previous quarter's top product was '手机'. Focus on the performance of '华东' and compare it with other regions. The total revenue for Q2 was 1500000.",
        "data_table": [
          {
            "区域": "华东",
            "核心产品": "手机",
            "季度收入": 1500000,
            "同比增长率": "12.5%",
            "活跃用户数": 12000
          },
          {
            "区域": "华北",
            "核心产品": "电脑",
            "季度收入": 950000,
            "同比增长率": "-3.2%",
            "活跃用户数": 8500
          }
        ]
      },
      "anonymization_rules": [
        {
          "strategy": "MAP_CODE",
          "applies_to": { "type": "REGION", "values": ["华东", "华北"] }
        },
        {
          "strategy": "MAP_CODE",
          "applies_to": { "type": "PRODUCT", "values": ["手机", "电脑"] }
        },
        {
          "strategy": "TRANSFORM",
          "strategy_params": { "noise_level": 0.05 },
          "applies_to": { "type": "REVENUE", "values": [1500000, 950000] }
        },
        {
          "strategy": "MAP_PLACEHOLDER",
          "applies_to": { "type": "USER_COUNT", "values": [12000, 8500] }
        },
        {
          "strategy": "PASSTHROUGH",
          "applies_to": { "type": "GROWTH_RATE", "values": ["12.5%", "-3.2%"] }
        }
      ]
    }
    ```
*   **Success Response (200 OK):**
    ```json
    {
      "session_id": "sess_a8f5b_random_string_here",
      "anonymized_payload": {
        "metadata": {
          "report_name": "Q3 Sales Analysis for {REGION_a3f5}",
          "requester": "user123"
        },
        "analysis_prompt": "Analyze the following sales data. The previous quarter's top product was 'PRODUCT_c8b1'. Focus on the performance of 'REGION_a3f5' and compare it with other regions. The total revenue for Q2 was 1532108.5.",
        "data_table": [
          {
            "区域": "REGION_a3f5",
            "核心产品": "PRODUCT_c8b1",
            "季度收入": 1532108.5,
            "同比增长率": "12.5%",
            "活跃用户数": "USER_COUNT_plc_1"
          },
          {
            "区域": "REGION_b1e9",
            "核心产品": "PRODUCT_d2a7",
            "季度收入": 988450.0,
            "同比增长率": "-3.2%",
            "活跃用户数": "USER_COUNT_plc_2"
          }
        ]
      },
      "mappings_to_store": {
        "categorical_mappings": {
          "REGION": { "REGION_a3f5": "华东", "REGION_b1e9": "华北" },
          "PRODUCT": { "PRODUCT_c8b1": "手机", "PRODUCT_d2a7": "电脑" }
        },
        "metric_placeholder_mappings": {
          "USER_COUNT_plc_1": 12000,
          "USER_COUNT_plc_2": 8500
        }
      }
    }
    ```
    *   **注意:** 返回体中明确提供了`mappings_to_store`，这是需要客户端（如业务编排服务）负责持久化到共享存储的关键数据。

---

#### **4. 解密服务 (Decryption Service)**

##### **4.1 功能与逻辑**

该服务接收一个包含匿名编码的载荷（**JSON对象** 或 **纯文本字符串**）和一份完整的映射表。它会遍历整个载荷，查找所有在映射表中定义的编码，并将其替换回原始的真实值。

##### **4.2 核心设计：处理AI返回的Text与JSON结构**

虽然本服务同时支持两种格式的解密，但**强制AI返回结构化JSON是确保整个数据处理流程安全、可靠、高效的最佳实践**。

*   **风险：当AI返回纯文本 (支持，但不推荐)**
    *   **处理方式:** 对整个文本字符串执行全局的、基于字典的查找和替换。
    *   **核心风险:**
        1.  **解密歧义性:** 简单的字符串替换无法区分上下文。一个编码（如`REGION_a3f5`）可能在文本中既是地名，又是某个报告ID的一部分，这会导致错误的替换和数据污染。
        2.  **结果不可编程:** 业务系统需要依赖脆弱的正则表达式或NLP技术才能从一大段话中提取关键信息，自动化程度低且极易出错。
        3.  **格式不可靠:** AI生成的文本在措辞、标点上的微小变化都可能破坏下游的解析逻辑。

*   **最佳实践：当AI返回JSON (强烈推荐)**
    *   **处理方式:** 递归地遍历JSON的每一个键和值。如果值是字符串，就对其执行查找和替换。
    *   **核心优势:**
        1.  **安全精确:** JSON的键值结构提供了天然的上下文。我们可以精确地只替换`"value": "REGION_a3f5"`，而不会错误地修改`"report_id": "report-for-REGION_a3f5"`。
        2.  **结果可靠可编程:** 返回的JSON可以被任何编程语言轻松解析为对象，使后续的自动化处理（如生成图表、更新仪表盘）变得简单而可靠。
        3.  **数据与表现解耦:** JSON可以将“数据结论”与“叙述风格”分离，前端可以根据需要自由地将结构化数据渲染成不同的表现形式。

##### **4.3 API接口**

*   **Endpoint:** `POST /v1/decrypt`
*   **Request Body:** `data_with_anonymized_codes` 字段可以是JSON对象或字符串。

    *   **示例1: 解密JSON对象 (推荐)**
        ```json
        {
          "data_with_anonymized_codes": {
            "summary": "REGION_a3f5 区域表现突出，主要贡献来自 PRODUCT_c8b1。",
            "key_findings": [
              { "dimension": "区域", "value": "REGION_a3f5" },
              { "dimension": "产品", "value": "PRODUCT_c8b1" }
            ]
          },
          "mappings": { /* ... 映射表 ... */ }
        }
        ```
    *   **示例2: 解密纯文本字符串**
        ```json
        {
          "data_with_anonymized_codes": "分析显示，REGION_a3f5 区域的 PRODUCT_c8b1 表现最佳，活跃用户数为 USER_COUNT_plc_1。",
          "mappings": { /* ... 映射表 ... */ }
        }
        ```

*   **Success Response (200 OK):** 返回的`decrypted_data`类型与请求中的`data_with_anonymized_codes`类型保持一致。

    *   **对应示例1的返回:**
        ```json
        {
          "decrypted_data": {
            "summary": "华东 区域表现突出，主要贡献来自 手机。",
            "key_findings": [
              { "dimension": "区域", "value": "华东" },
              { "dimension": "产品", "value": "手机" }
            ]
          }
        }
        ```
    *   **对应示例2的返回:**
        ```json
        {
          "decrypted_data": "分析显示，华东 区域的 手机 表现最佳，活跃用户数为 12000。"
        }
        ```

---

#### **5. AI集成最佳实践：提示词工程指南**

为确保AI能够稳定地返回我们所期望的、结构化的、可安全解密的JSON结果，我们为AI应用开发者提供以下“黄金”指南。

##### **5.1 推荐的“黄金”JSON返回结构**

建议设计一个通用的、分层的JSON结构，以承载绝大多数分析任务的结果。这兼顾了“给人看”（叙述层）和“给机器读”（数据层）的需求。

```json
{
  "request_summary": { /* ... 元数据，用于追踪和审计 ... */ },
  "executive_summary": {
    "title": "关于 {REGION_a3f5} 区域的分析报告",
    "narrative": "本季度，{REGION_a3f5} 的表现最为突出，主要得益于 {PRODUCT_c8b1} 的增长。",
    "key_takeaways": [ "主要增长动力来自 {REGION_a3f5}。" ]
  },
  "structured_findings": [
    {
      "finding_type": "TOP_PERFORMER",
      "entity": { "type": "REGION", "code": "REGION_a3f5" },
      "metrics": [
        { "name": "活跃用户数(占位符)", "value_placeholder": "USER_COUNT_plc_1" }
      ]
    }
  ],
  "error_info": { "has_error": false, "error_message": null }
}
```

##### **5.2 “黄金提示词”模板**

在向AI发送请求时，使用结构化的提示词，明确告知其输入、输出的格式和规则，是成功的关键。

```text
### 系统指令 (System Role) ###
你是一名专业的、严谨的数据分析师。你的任务是分析我提供的数据，并严格按照我指定的JSON格式返回结果。绝对不要在JSON格式之外添加任何额外的解释。

### 输入数据 (Input Data) ###
{
  "analysis_goal": "找出销售收入最高的区域。",
  "data_definitions": {
    "区域": "地理销售大区，已用'REGION_CODE'格式编码。"
  },
  "data_table": [
    { "区域": "REGION_a3f5", "季度收入": 1532108.5 },
    { "区域": "REGION_b1e9", "季度收入": 988450.0 }
  ]
}

### 输出指令 (Output Instruction) ###
请你执行分析，并严格按照以下JSON Schema格式返回你的发现。不要有任何偏离。
{
  // 在此处粘贴你的“黄金”JSON结构骨架
  "executive_summary": {
    "narrative": "（请在此处撰写一段包含编码的总结）"
  },
  "structured_findings": [
    {
      "finding_type": "TOP_PERFORMER",
      "entity": {
        "type": "REGION",
        "code": "（请填入表现最好的区域编码）"
      }
    }
  ]
}

### 最终回答 (Your Final Answer) ###
```

通过遵循此集成指南，业务系统可以最大化地利用本隐私保护服务的价值，构建安全、可靠且高度自动化的AI数据分析流程。