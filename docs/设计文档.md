好的，作为一名顶级的架构师，我将为您整合并优化这两份文档，创建一个单一、清晰、完整的最终设计文档。

新文档将无缝融入“AI返回JSON结构”的设计理念，并根据您的要求重新设计密钥管理和增加日志记录功能。解密服务将明确支持文本和JSON两种载体，同时强调JSON作为最佳实践的战略价值。

---

### **通用数据隐私保护服务 - 统一设计文档**

**文档版本:** 3.0
**核心焦点:** 为AI交互设计的、具备多租户密钥管理和详细日志记录的匿名化与解密服务。
**最后更新:** 2025年10月23日

#### **1. 服务概述**

本设计文档定义了两个独立、无状态的HTTP微服务：**匿名化服务**和**解密服务**。这两个服务共同构成了一套通用的数据隐私保护解决方案，旨在安全地处理需要与第三方系统（如大型语言模型AI）交互的结构化和非结构化数据。

*   **匿名化服务 (Anonymization Service):** 接收一份包含潜在敏感信息的JSON载荷，并根据一组明确的规则，将其转换为一份结构相同但敏感信息已被替换为安全编码的匿名化载荷。
*   **解密服务 (Decryption Service):** 接收一份包含安全编码的纯文本字符串（通常由AI返回），并利用匿名化过程中产生的映射关系，将其还原为一份包含原始真实数据的可读文本。

这两个服务被设计为纯粹的功能转换器，不包含任何业务逻辑，确保了其高度的可复用性、健壮性和通用性。

---

#### **2. 密钥管理、鉴权与日志**

##### **2.1 密钥管理**

为了支持多个不同的业务系统（租户）安全地接入本服务，密钥管理采用基于配置文件的方式，为每个系统分配独立的密钥。

*   **配置文件 (`config.json`):** 服务在启动时加载此文件，其中包含了所有接入系统的认证信息。

    ```json
    {
      "systems": [
        {
          "system_id": "BI_REPORT_SYSTEM",
          "shared_secret": "a_very_strong_and_long_secret_for_bi",
          "description": "商业智能报表分析系统"
        },
        {
          "system_id": "CUSTOMER_SERVICE_BOT",
          "shared_secret": "another_unique_secret_for_the_chatbot",
          "description": "客户服务聊天机器人"
        }
      ]
    }
    ```

##### **2.2 鉴权机制**

所有API调用都必须经过鉴权。采用基于HMAC的Token机制，并与多租户密钥管理相结合。

*   **Token生成 (由客户端完成):**
    1.  客户端必须明确自己的`system_id`。
    2.  **签名内容:** 拼接字符串 `SystemID + UserID + UnixTimestamp + SHA256(RequestBody)`。
    3.  **签名:** `Signature = HMAC-SHA256(SHARED_SECRET_FOR_SYSTEM, 签名内容)`。
    4.  **HTTP头:**
        ```
        Authorization: MCP-HMAC-SHA256 SystemID={...},UserID={...},Timestamp={...},Signature={...}
        ```

*   **Token验证 (在服务入口中间件完成):**
    1.  从`Authorization`头中解析出`SystemID`。
    2.  根据`SystemID`从配置中查找对应的`shared_secret`。如果未找到，拒绝请求。
    3.  校验时间戳是否在有效窗口内（建议5分钟）。
    4.  在服务端使用查找到的密钥重新计算签名，并与客户端传入的`Signature`进行比对。

##### **2.3 日志记录**

所有请求（无论成功或失败）都必须被记录，以便进行审计、监控和问题排查。日志应采用结构化的JSON格式。

*   **日志内容:**
    ```json
    {
      "timestamp": "2025-10-23T08:30:00.123Z",
      "request_id": "uuid-v4-of-the-request",
      "service": "DecryptionService", // 或 AnonymizationService
      "system_id": "BI_REPORT_SYSTEM",
      "user_id": "user123",
      "status": "SUCCESS", // 或 FAILED
      "latency_ms": 15,
      "error_message": null // 或具体的错误信息
    }
    ```

---

#### **3. 匿名化服务 (Anonymization Service)**

##### **3.1 功能与逻辑**

该服务接收一个JSON载荷和一组规则。它会递归地遍历整个载荷，查找所有在规则中被声明为敏感的值，并根据指定的策略进行替换，同时生成一份供解密服务使用的映射表。

*   **核心能力:**
    *   **载荷不可知:** 能处理任意复杂的JSON结构。
    *   **全局替换:** 一个敏感值无论出现多少次，都会被一致地替换为同一个编码。
    *   **策略驱动:** 支持多种隐私保护策略（映射编码、加噪、占位符等）。
    *   **映射生成:** 生成一份详细的“编码 -> 真实值”的映射表。

##### **3.2 API接口**


*   **Endpoint:** `POST /v1/anonymize`
*   **Request Body (清晰示例):**

    ```json
    {
      "payload": {
        "metadata": {
          "report_name": "Q3 Sales Analysis for 华东",
          "requester": "user123"
        },
        "analysis_prompt": "Analyze the following sales data. The previous quarter's top product was '{手机}'. Focus on the performance of '{华东}' and compare it with other regions. The total revenue for Q2 was 1500000.",
        "data_table": [
          {
            "区域": "华东",
            "核心产品": "手机",
            "季度收入": 1500000,
            "同比增长率": "12.5%",
            "活跃用户数": 12000
          },
          {
            "区域": "华北",
            "核心产品": "电脑",
            "季度收入": 950000,
            "同比增长率": "-3.2%",
            "活跃用户数": 8500
          }
        ]
      },
      "anonymization_rules": [
        {
          "strategy": "MAP_CODE",
          "applies_to": { "type": "REGION", "values": ["华东", "华北"] }
        },
        {
          "strategy": "MAP_CODE",
          "applies_to": { "type": "PRODUCT", "values": ["手机", "电脑"] }
        },
        {
          "strategy": "TRANSFORM",
          "strategy_params": { "noise_level": 0.05 },
          "applies_to": { "type": "REVENUE", "values": [1500000, 950000] }
        },
        {
          "strategy": "MAP_PLACEHOLDER",
          "applies_to": { "type": "USER_COUNT", "values": [12000, 8500] }
        },
        {
          "strategy": "PASSTHROUGH",
          "applies_to": { "type": "GROWTH_RATE", "values": ["12.5%", "-3.2%"] }
        }
      ]
    }
    ```
*   **Success Response (200 OK):**
    ```json
    {
      "anonymized_payload": {
        "metadata": {
          "report_name": "Q3 Sales Analysis for REGION_a3f5",
          "requester": "user123"
        },
        "analysis_prompt": "Analyze the following sales data. The previous quarter's top product was 'PRODUCT_c8b1'. Focus on the performance of 'REGION_a3f5' and compare it with other regions. The total revenue for Q2 was 1532108.5.",
        "data_table": [
          {
            "区域": "REGION_a3f5",
            "核心产品": "PRODUCT_c8b1",
            "季度收入": 1532108.5,
            "同比增长率": "12.5%",
            "活跃用户数": "USER_COUNT_plc_1"
          },
          {
            "区域": "REGION_b1e9",
            "核心产品": "PRODUCT_d2a7",
            "季度收入": 988450.0,
            "同比增长率": "-3.2%",
            "活跃用户数": "USER_COUNT_plc_2"
          }
        ]
      },
      "mappings_to_store": {
        "categorical_mappings": {
          "REGION": { "REGION_a3f5": "华东", "REGION_b1e9": "华北" },
          "PRODUCT": { "PRODUCT_c8b1": "手机", "PRODUCT_d2a7": "电脑" }
        },
        "metric_placeholder_mappings": {
          "USER_COUNT_plc_1": 12000,
          "USER_COUNT_plc_2": 8500
        }
      }
    }
    ```
    *   **注意:** 返回体中明确提供了`mappings_to_store`，这是需要客户端（如业务编排服务）负责持久化到共享存储的关键数据。

---

#### **4. 解密服务 (Decryption Service)**

##### **4.1 功能与逻辑**

该服务接收一个包含匿名编码的纯文本字符串（通常由AI返回）和一份完整的映射表。它会查找文本中所有在映射表中定义的编码（格式为`{编码}`），并将其替换回原始的真实值。

##### **4.2 核心设计：纯文本解密与编码格式**

**编码存储与传输的优化设计：**

*   **匿名化输出**：payload中的编码不带大括号（如 `REGION_a3f5`），减少数据量
*   **映射表存储**：存储不带大括号的编码，节省存储空间和传输带宽
*   **AI处理要求**：AI在返回文本时，必须主动给编码添加大括号（如 `{REGION_a3f5}`）
*   **解密匹配**：只替换带大括号格式的编码，避免错误替换

**设计优势：**

*   **数据量优化**：映射表和匿名化输出不包含冗余的大括号字符
*   **避免错误替换**：大括号提供了明确的边界，只有 `{REGION_a3f5}` 会被替换，`REGION_a3f5_extra` 不会
*   **提高安全性**：明确的编码格式减少了意外替换正常文本的风险
*   **灵活性**：支持精确匹配（完全相等）和模糊匹配（文本中查找）两种场景

##### **4.3 API接口**

*   **Endpoint:** `POST /v1/decrypt`
*   **Request Body:** `data_with_anonymized_codes` 字段只接受纯文本字符串。

    *   **解密纯文本字符串示例:**
        ```json
        {
          "data_with_anonymized_codes": "分析显示，{REGION_a3f5} 区域的 {PRODUCT_c8b1} 表现最佳，活跃用户数为 {USER_COUNT_plc_1}。",
          "mappings": {
            "categorical_mappings": {
              "REGION": { "REGION_a3f5": "华东" },
              "PRODUCT": { "PRODUCT_c8b1": "手机" }
            },
            "metric_placeholder_mappings": {
              "USER_COUNT_plc_1": 12000
            }
          }
        }
        ```
    
    **注意**：
    - 映射表中的编码不包含大括号（如 `REGION_a3f5`）
    - 待解密文本中的编码必须包含大括号（如 `{REGION_a3f5}`）
    - AI必须主动添加大括号来标记编码位置

*   **Success Response (200 OK):** 返回解密后的纯文本字符串。

    *   **解密结果示例:**
        ```json
        {
          "decrypted_data": "分析显示，华东 区域的 手机 表现最佳，活跃用户数为 12000。"
        }
        ```

---

#### **5. AI集成最佳实践：提示词工程指南**

为确保AI能够稳定地返回包含正确编码格式的纯文本结果，我们为AI应用开发者提供以下指南。

##### **5.1 编码格式要求**

**重要：** 匿名化服务返回的payload中，编码不带大括号（如 `REGION_a3f5`）。但AI在处理和返回文本时，必须主动给编码添加大括号标记。

*   **匿名化输出格式：** `REGION_a3f5`、`PRODUCT_c8b1`、`USER_COUNT_plc_1`（不带大括号）
*   **AI必须返回格式：** `{REGION_a3f5}`、`{PRODUCT_c8b1}`、`{USER_COUNT_plc_1}`（带大括号）
*   **错误格式：** `[REGION_a3f5]`、`<REGION_a3f5>`或不添加任何标记

##### **5.2 "标准提示词"模板**

在向AI发送请求时，必须明确告知其使用大括号编码格式：

```text
### 系统指令 (System Role) ###
你是一名专业的数据分析师。请分析提供的数据并返回纯文本分析结果。

**重要编码格式要求：**
- 输入数据中的编码是不带大括号的（如 REGION_a3f5）
- 但在你的回答中，所有编码必须用大括号包裹（如 {REGION_a3f5}）
- 这样做是为了在解密时能精确识别编码位置，避免误替换

### 输入数据 (Input Data) ###
{
  "analysis_goal": "找出销售收入最高的区域",
  "data_table": [
    { "区域": "REGION_a3f5", "季度收入": 1532108.5 },
    { "区域": "REGION_b1e9", "季度收入": 988450.0 }
  ]
}

### 输出要求 ###
请返回纯文本分析结果，确保所有编码都用大括号包裹，格式为 {编码}。

### 分析结果 ###
```

##### **5.3 示例AI回答**

```text
根据数据分析，{REGION_a3f5} 区域的季度收入最高，达到1532108.5，表现优于 {REGION_b1e9} 区域。建议继续关注 {REGION_a3f5} 区域的发展趋势，并分析其成功因素以复制到其他区域。
```

通过遵循此集成指南，业务系统可以确保AI返回的文本能够被解密服务正确处理，避免编码替换错误。