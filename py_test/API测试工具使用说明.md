# API测试工具使用说明

## 概述

`test_api.py` 是一个用于测试数据匿名化与解密服务接口的Python脚本。该脚本提供了完整的HMAC签名生成、接口调用和详细的调试信息输出功能，方便开发者在服务启动后进行手动测试和调试。

## 功能特性

- ✅ **完整的HMAC签名生成** - 严格按照服务要求的签名算法
- ✅ **详细的调试信息输出** - 打印token、签名内容、请求体等关键信息
- ✅ **支持所有接口测试** - 匿名化、JSON解密、文本解密
- ✅ **交互式测试界面** - 支持选择不同的测试场景
- ✅ **自动映射表保存** - 匿名化后自动保存映射表供解密测试使用
- ✅ **错误处理和超时控制** - 完善的异常处理和超时机制

## 环境要求

- Python 3.6+
- 依赖包: `requests`

## 安装依赖

```bash
pip install requests
```

## 使用方法

### 1. 基本使用

```bash
# 默认连接到 localhost:8080
python test_api.py

# 连接到指定地址
python test_api.py http://192.168.1.100:8080
```

### 2. 测试选项

运行脚本后，会出现交互式菜单：

```
🔧 数据匿名化与解密服务 - API测试工具
==================================================

请选择测试选项:
1. 运行完整测试流程
2. 仅测试匿名化接口
3. 仅测试解密接口（JSON格式）
4. 仅测试解密接口（纯文本格式）
5. 退出
```

### 3. 测试流程说明

#### 选项1: 完整测试流程
1. 调用 `/v1/anonymize` 接口进行数据匿名化
2. 自动保存映射表到 `test_mappings.json`
3. 调用 `/v1/decrypt` 接口进行JSON格式解密
4. 调用 `/v1/decrypt` 接口进行纯文本格式解密

#### 选项2: 仅匿名化测试
- 测试数据匿名化功能
- 生成并保存映射表
- 打印详细的调试信息

#### 选项3/4: 解密测试
- 支持JSON和纯文本两种格式的解密
- 使用之前保存的映射表或示例映射表

## 调试信息说明

测试脚本会输出详细的调试信息，包括：

### 签名相关信息
- 🔑 **签名**: HMAC-SHA256签名值
- ⏰ **时间戳**: 签名时间戳
- 📄 **请求体哈希**: 请求体的SHA256哈希值
- 📝 **签名内容**: 用于签名的原始字符串
- 🔐 **Authorization头**: 完整的认证头信息

### 请求信息
- 📡 **目标接口**: 调用的API端点
- 👤 **系统ID/用户ID**: 认证信息
- 📦 **请求体**: 完整的请求JSON数据

### 响应信息
- 📡 **状态码**: HTTP响应状态码
- 📡 **响应头**: 服务器返回的头部信息
- 📊 **响应体**: 服务器返回的JSON数据

## 测试数据说明

### 匿名化测试数据
```json
{
  "session_id": "sess_时间戳",
  "payload": {
    "metadata": {
      "report_name": "Q3 Sales Analysis for {华东}",
      "requester": "test_user_001"
    },
    "analysis_prompt": "分析销售数据...",
    "data_table": [
      {
        "区域": "华东",
        "核心产品": "手机",
        "季度收入": 1500000,
        "同比增长率": "12.5%",
        "活跃用户数": 12000
      }
    ]
  },
  "anonymization_rules": [
    {
      "strategy": "MAP_CODE",
      "applies_to": {"type": "REGION", "values": ["华东", "华北"]}
    }
  ]
}
```

### 解密测试数据
- **JSON格式**: 结构化的AI返回数据
- **纯文本格式**: 包含编码的文本字符串

## 系统配置

测试脚本使用 `config.example.json` 中的系统配置：

- **BI_REPORT_SYSTEM**: 商业智能报表分析系统
- **CUSTOMER_SERVICE_BOT**: 客户服务聊天机器人

## 日志检查建议

在运行测试后，建议检查服务日志文件 `logs/service.log` 来验证：

1. **请求记录**: 确认服务收到了测试请求
2. **鉴权日志**: 检查HMAC签名验证结果
3. **处理日志**: 查看匿名化/解密的处理过程
4. **错误日志**: 排查可能的错误信息

## 常见问题

### Q: 连接被拒绝怎么办？
A: 确保服务已启动并在指定端口运行，检查防火墙设置。

### Q: 签名验证失败怎么办？
A: 检查系统ID和密钥配置是否与服务端一致，确认时间戳在有效窗口内。

### Q: 映射表文件不存在怎么办？
A: 脚本会自动使用示例映射表，或先运行匿名化测试生成映射表。

### Q: 如何测试其他系统？
A: 修改脚本中的 `test_systems` 字典，添加对应的系统配置。

## 安全提示

- 🔒 测试脚本中的密钥仅为示例，生产环境请使用强密钥
- 🔒 不要在版本控制中提交包含真实密钥的配置文件
- 🔒 生产环境务必使用HTTPS协议

## 扩展使用

### 自定义测试数据
修改脚本中的测试数据来验证不同的业务场景：

```python
# 修改匿名化规则
"anonymization_rules": [
    {
        "strategy": "TRANSFORM",
        "strategy_params": {"noise_level": 0.1},
        "applies_to": {"type": "SENSITIVE_NUMBER", "values": [1000, 2000]}
    }
]
```

### 批量测试
可以修改脚本支持批量测试多个不同的数据场景。

---

**注意**: 我已经对代码进行了逻辑审查。请您手动进行全面的测试以确保其行为符合预期。